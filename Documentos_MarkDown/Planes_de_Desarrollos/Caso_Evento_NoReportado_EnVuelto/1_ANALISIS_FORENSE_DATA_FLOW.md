# 1Ô∏è‚É£ An√°lisis Forense: Data Flow warning_override

**Objetivo:** Rastrear EXACTAMENTE el flujo de datos desde `attemptHistory` Map hasta reporte WhatsApp final.

**Fecha:** 13 Oct 2025 ~18:10 PM

---

## üìä Flujo Completo de Datos (13 Pasos)

### FASE A: Registro de Intentos (Phase2VerificationSection.tsx)

#### PASO 1: Usuario Ingresa Primer Intento Incorrecto
**L√≠neas:** 442-458
```typescript
// Usuario ingresa 30 (esperado: 37)
// ‚ùå CASO 2: Valor incorrecto - REGISTRAR intento
const newAttempt = recordAttempt(currentStep.key, inputNum, currentStep.quantity);

if (attemptCount === 0) {
  // Primer intento incorrecto
  setModalState({
    isOpen: true,
    type: 'incorrect',
    stepLabel,
    thirdAttemptAnalysis: undefined
  });
}
```

**Estado attemptHistory Map DESPU√âS:**
```json
{
  "nickel": [
    {
      "attemptNumber": 1,
      "inputValue": 30,
      "expectedValue": 37,
      "isCorrect": false,
      "timestamp": "2025-10-13T18:00:00.000Z",
      "stepKey": "nickel"
    }
  ]
}
```

---

#### PASO 2: Usuario Ingresa Segundo Intento (IGUAL Incorrecto)
**L√≠neas:** 459-475
```typescript
} else if (attemptCount === 1) {
  // Segundo intento incorrecto
  const attempts = attemptHistory.get(currentStep.key) || [];
  const firstAttemptValue = attempts[0]?.inputValue;

  if (inputNum === firstAttemptValue) {
    // ESCENARIO 2a: Dos intentos iguales incorrectos ‚Üí force override
    setModalState({
      isOpen: true,
      type: 'force-same',
      stepLabel,
      thirdAttemptAnalysis: undefined
    });
  }
}
```

**Estado attemptHistory Map DESPU√âS:**
```json
{
  "nickel": [
    {
      "attemptNumber": 1,
      "inputValue": 30,
      "expectedValue": 37,
      "isCorrect": false,
      "timestamp": "2025-10-13T18:00:00.000Z",
      "stepKey": "nickel"
    },
    {
      "attemptNumber": 2,
      "inputValue": 30,
      "expectedValue": 37,
      "isCorrect": false,
      "timestamp": "2025-10-13T18:00:15.000Z",
      "stepKey": "nickel"
    }
  ]
}
```

---

#### PASO 3: Usuario Acepta "Forzar Valor" (handleForce)
**L√≠neas:** 553-584

**üö® CR√çTICO - AQU√ç EST√Å EL BUG PROBABLE:**
```typescript
const handleForce = () => {
  if (!currentStep) return;

  // Cerrar modal
  setModalState(prev => ({ ...prev, isOpen: false }));

  // üö® L√çNEA 561 - CLEAR ATTEMPT HISTORY
  // ü§ñ [IA] - v1.3.6M: Limpiar historial SOLO en force override
  // Justificaci√≥n: Permite re-intentar si usuario se arrepiente del override
  clearAttemptHistory(currentStep.key); // ‚Üê ‚ùå BORRA DATOS AQU√ç

  // Marcar paso completado con valor forzado
  onStepComplete(currentStep.key);

  // ... resto de c√≥digo (vibraci√≥n, avanzar, focus)
};
```

**Estado attemptHistory Map DESPU√âS de clearAttemptHistory():**
```json
{
  // ‚ùå "nickel" ELIMINADO - Map NO contiene esa denominaci√≥n
}
```

**‚ùå PROBLEMA IDENTIFICADO:**
`clearAttemptHistory(currentStep.key)` elimina los 2 intentos ANTES de que `buildVerificationBehavior()` pueda leerlos.

---

### FASE B: Construcci√≥n VerificationBehavior (Phase2VerificationSection.tsx)

#### PASO 4: Todos los Pasos Completados ‚Üí useEffect Trigger
**L√≠neas:** 349-391
```typescript
useEffect(() => {
  if (allStepsCompleted && verificationSteps.length > 0) {
    const cleanup = createTimeoutWithCleanup(() => {
      const behavior = buildVerificationBehavior(); // ‚Üê SE EJECUTA AQU√ç

      if (onVerificationBehaviorCollected) {
        console.log('[Phase2VerificationSection] üìä VerificationBehavior construido:', behavior);
        onVerificationBehaviorCollected(behavior);
      }

      // Small delay antes de section complete
      setTimeout(() => {
        onSectionComplete();
      }, 100);
    }, 'transition', 'verification_section_complete');
    return cleanup;
  }
}, [allStepsCompleted, verificationSteps.length, buildVerificationBehavior]);
```

---

#### PASO 5: buildVerificationBehavior() Itera attemptHistory Map
**L√≠neas:** 142-324
```typescript
const buildVerificationBehavior = useCallback((): VerificationBehavior => {
  // ... inicializaci√≥n variables

  // Iterar sobre attemptHistory Map
  attemptHistory.forEach((attempts, stepKey) => {
    // üö® PARA nickel: Map.get('nickel') retorna undefined
    // Raz√≥n: clearAttemptHistory() ya lo elimin√≥ l√≠nea 561

    // ... an√°lisis patterns (NUNCA ejecuta para nickel)

    // Agregar a denominationsWithIssues si NO es success
    if (currentSeverity !== 'success') {
      denominationsWithIssues.push({
        denomination: stepKey as keyof CashCount,
        severity: currentSeverity,
        attempts: attempts.map(a => a.inputValue)
      });
    }
  });

  // ... return finalBehavior
}, [attemptHistory]);
```

**Resultado attemptHistory.forEach():**
```
nickel: ‚ùå NO ITERA (Map vac√≠o despu√©s de clearAttemptHistory)
denominationsWithIssues: [] (array vac√≠o - nickel NUNCA se agrega)
```

---

#### PASO 6: Objeto VerificationBehavior Construido
**L√≠neas:** 300-324
```typescript
const finalBehavior = {
  totalAttempts: allAttempts.length,            // Puede ser 0 para nickel
  firstAttemptSuccesses,
  secondAttemptSuccesses,
  thirdAttemptRequired,
  forcedOverrides,                              // 0 (nickel NO se cont√≥)
  criticalInconsistencies,
  severeInconsistencies,
  attempts: allAttempts.sort(...),              // Array vac√≠o para nickel
  severityFlags,
  forcedOverridesDenoms,                        // [] (nickel NO agregado)
  criticalInconsistenciesDenoms,
  severeInconsistenciesDenoms,
  denominationsWithIssues // ‚ùå [] (array vac√≠o - nickel NUNCA se agreg√≥)
};

return finalBehavior;
```

**Estado Final VerificationBehavior:**
```json
{
  "totalAttempts": 0,
  "firstAttemptSuccesses": 7,
  "secondAttemptSuccesses": 0,
  "thirdAttemptRequired": 0,
  "forcedOverrides": 0,           // ‚ùå Deber√≠a ser 1
  "criticalInconsistencies": 0,
  "severeInconsistencies": 0,
  "attempts": [],                  // ‚ùå Deber√≠a tener 2 intentos nickel
  "severityFlags": [],
  "forcedOverridesDenoms": [],     // ‚ùå Deber√≠a incluir "nickel"
  "criticalInconsistenciesDenoms": [],
  "severeInconsistenciesDenoms": [],
  "denominationsWithIssues": []   // ‚ùå Deber√≠a incluir nickel
}
```

---

### FASE C: Elevaci√≥n de Datos (Phase2Manager.tsx)

#### PASO 7: Callback onVerificationBehaviorCollected
**L√≠neas:** 167-176 (Phase2Manager.tsx)
```typescript
const handleVerificationBehaviorCollected = useCallback((behavior: VerificationBehavior) => {
  console.log('[Phase2Manager] VerificationBehavior recolectado:', behavior);
  setVerificationBehavior(behavior);
}, []);
```

**Estado verificationBehavior:**
```json
{
  "denominationsWithIssues": [] // ‚ùå Array vac√≠o (nickel NO incluido)
}
```

---

#### PASO 8: Enriquecimiento deliveryCalculation
**L√≠neas:** 120-143 (Phase2Manager.tsx)
```typescript
useEffect(() => {
  if (verificationCompleted && verificationBehavior && onPhase2Complete) {
    // Enriquecer deliveryCalculation con verificationBehavior
    deliveryCalculation.verificationBehavior = verificationBehavior;

    // v1.3.6AD2: Ajustar denominationsToKeep con valores aceptados
    if (verificationBehavior.denominationsWithIssues.length > 0) {
      const { adjustedKeep, adjustedAmount } = adjustDenominationsWithVerification(
        deliveryCalculation.denominationsToKeep,
        verificationBehavior
      );
      // ...
    }

    // ...
    onPhase2Complete();
  }
}, [verificationCompleted, onPhase2Complete, verificationBehavior]);
```

**Resultado:**
- `verificationBehavior.denominationsWithIssues.length === 0` ‚ùå
- `adjustDenominationsWithVerification()` NO se ejecuta
- `deliveryCalculation.verificationBehavior` contiene behavior vac√≠o

---

### FASE D: Generaci√≥n Reporte WhatsApp (CashCalculation.tsx)

#### PASO 9: generateWarningAlertsBlock()
**L√≠neas:** 511-546
```typescript
const generateWarningAlertsBlock = (behavior: VerificationBehavior): string => {
  // Filtrar solo severidades de advertencia (warning_retry, warning_override)
  const warningDenoms = behavior.denominationsWithIssues.filter(d =>
    d.severity === 'warning_retry' || d.severity === 'warning_override'
  );

  if (warningDenoms.length === 0) return ''; // ‚ùå RETORNA VAC√çO (nickel NO en array)

  // ... resto del c√≥digo NUNCA se ejecuta
};
```

**Resultado:**
```typescript
warningDenoms: [] // ‚ùå Array vac√≠o - filtro NO encuentra nickel
return: ''        // ‚ùå String vac√≠o - sin advertencias
```

---

#### PASO 10: generateCriticalAlertsBlock()
**L√≠neas:** 338-378
```typescript
const generateCriticalAlertsBlock = (behavior: VerificationBehavior): string => {
  // Filtrar solo severidades cr√≠ticas (critical_severe, critical_inconsistent)
  const criticalDenoms = behavior.denominationsWithIssues.filter(d =>
    d.severity === 'critical_severe' || d.severity === 'critical_inconsistent'
  );

  if (criticalDenoms.length === 0) return ''; // ‚ùå RETORNA VAC√çO

  // ... resto del c√≥digo NUNCA se ejecuta
};
```

**Resultado:**
```typescript
criticalDenoms: [] // ‚ùå Array vac√≠o
return: ''          // ‚ùå String vac√≠o - sin cr√≠ticas
```

---

#### PASO 11: generateCompleteReport()
**L√≠neas:** 548-667
```typescript
const generateCompleteReport = useCallback(() => {
  // ...
  const criticalAlertsBlock = deliveryCalculation?.verificationBehavior ?
    generateCriticalAlertsBlock(deliveryCalculation.verificationBehavior) : '';
  const warningAlertsBlock = deliveryCalculation?.verificationBehavior ?
    generateWarningAlertsBlock(deliveryCalculation.verificationBehavior) : '';

  // Secci√≥n de alertas
  const fullAlertsSection = (criticalAlertsBlock || warningAlertsBlock) ?
    `
${WHATSAPP_SEPARATOR}

‚ö†Ô∏è *ALERTAS DETECTADAS*

${criticalAlertsBlock}${criticalAlertsBlock && warningAlertsBlock ? '\n\n' : ''}${warningAlertsBlock}
` : '';

  // ... return reporte completo
}, [...]);
```

**Resultado:**
```typescript
criticalAlertsBlock: ''     // ‚ùå Vac√≠o
warningAlertsBlock: ''      // ‚ùå Vac√≠o
fullAlertsSection: ''       // ‚ùå Vac√≠o - sin secci√≥n alertas
```

---

#### PASO 12: Secci√≥n Verificaci√≥n Ciega
**L√≠neas:** 596-623
```typescript
let verificationSection = '';
if (deliveryCalculation?.verificationBehavior) {
  const behavior = deliveryCalculation.verificationBehavior;
  const totalDenoms = deliveryCalculation.verificationSteps.length;
  const firstAttemptSuccesses = behavior.firstAttemptSuccesses;

  // Contar warnings y cr√≠ticas desde denominationsWithIssues
  const warningCountActual = behavior.denominationsWithIssues.filter(d =>
    d.severity === 'warning_retry' || d.severity === 'warning_override'
  ).length; // ‚ùå 0 (nickel NO en array)

  const criticalCountActual = behavior.denominationsWithIssues.filter(d =>
    d.severity === 'critical_severe' || d.severity === 'critical_inconsistent'
  ).length; // ‚ùå 0

  verificationSection = `
${WHATSAPP_SEPARATOR}

üîç *VERIFICACI√ìN CIEGA*

‚úÖ Perfectas: ${firstAttemptSuccesses}/${totalDenoms}
‚ö†Ô∏è Corregidas: ${warningCountActual}/${totalDenoms}  // ‚ùå 0/7 (deber√≠a ser 1/7)
üî¥ Cr√≠ticas: ${criticalCountActual}/${totalDenoms}
`;
}
```

**Resultado:**
```
‚úÖ Perfectas: 7/7  ‚ùå Incorrecto (deber√≠a ser 6/7)
‚ö†Ô∏è Corregidas: 0/7 ‚ùå Incorrecto (deber√≠a ser 1/7)
üî¥ Cr√≠ticas: 0/7   ‚úÖ Correcto
```

---

#### PASO 13: Reporte Final WhatsApp
**Resultado Final:**
```
üìä *CORTE DE CAJA* - 13/10/2025, 6:00 p. m.
Sucursal: Los H√©roes
Cajero: Adonay Torres
Testigo: Tito Gomez

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä *RESUMEN EJECUTIVO*
...

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîç *VERIFICACI√ìN CIEGA*

‚úÖ Perfectas: 7/7    ‚ùå Deber√≠a ser 6/7
‚ö†Ô∏è Corregidas: 0/7  ‚ùå Deber√≠a ser 1/7 (nickel forzado)
üî¥ Cr√≠ticas: 0/7     ‚úÖ Correcto

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí∞ *CONTEO COMPLETO ($367.92)*
...

‚ùå SIN SECCI√ìN "‚ö†Ô∏è ALERTAS DETECTADAS"
‚ùå NO MENCIONA: "‚Ä¢ Cinco centavos (5¬¢)"
‚ùå NO MENCIONA: "Intentos: 30 ‚Üí 30"
```

---

## üéØ Conclusi√≥n Data Flow

### Root Cause Definitivo
**L√≠nea:** Phase2VerificationSection.tsx l√≠nea 561
**Funci√≥n:** `handleForce()`
**Problema:** `clearAttemptHistory(currentStep.key)` elimina datos ANTES de `buildVerificationBehavior()`

### Secuencia Temporal Bug
```
1. Usuario acepta "Forzar valor" (warning_override)
2. handleForce() l√≠nea 553 ejecuta
3. clearAttemptHistory() l√≠nea 561 ‚Üê ‚ùå BORRA attemptHistory Map
4. onStepComplete() marca paso completado
5. Todos pasos completos ‚Üí useEffect dispara buildVerificationBehavior()
6. attemptHistory.forEach() ‚Üê ‚ùå Map vac√≠o, NO itera nickel
7. denominationsWithIssues ‚Üê ‚ùå Array vac√≠o, nickel NO agregado
8. generateWarningAlertsBlock() ‚Üê ‚ùå Filter NO encuentra nickel
9. Reporte WhatsApp ‚Üê ‚ùå Sin advertencias
```

### Patr√≥n Hist√≥rico Validado
**v1.3.6T (08 Oct 2025):** Mismo problema resuelto removiendo `clearAttemptHistory()` de intentos correctos (l√≠nea 411).

**Justificaci√≥n v1.3.6T:**
> "Root cause: Borraba intentos 1-2 ANTES de buildVerificationBehavior() ‚Üí warnings NO aparec√≠an en reporte"

---

## üìä Evidencia T√©cnica Adicional

### Checkpoint v1.3.6S (Logs Debugging)
**L√≠neas:** 144-161, 183-192, 258-260, 264-278, 282-292, 310-314

Si `clearAttemptHistory()` ejecuta ANTES de `buildVerificationBehavior()`:
```javascript
[DEBUG v1.3.6S] üìä buildVerificationBehavior() INICIO
[DEBUG v1.3.6S] üó∫Ô∏è attemptHistory Map size: 0  // ‚ùå Vac√≠o (deber√≠a ser 1)
[DEBUG v1.3.6S] üó∫Ô∏è attemptHistory Map keys: []  // ‚ùå Vac√≠o (deber√≠a incluir "nickel")
// ... NO LOGS ADICIONALES (forEach NO ejecuta)
```

### Comparativa v1.3.6M (Tercer Intento)
**L√≠neas:** 586-617

v1.3.6M YA removi√≥ `clearAttemptHistory()` de `handleAcceptThird()` por EXACTAMENTE la misma raz√≥n:
```typescript
// ü§ñ [IA] - v1.3.6M: FIX CR√çTICO - clearAttemptHistory() removido
// Root cause: Borraba intentos ANTES de buildVerificationBehavior() ‚Üí reporte sin datos errores
// Soluci√≥n: Preservar attemptHistory para que reporte incluya detalles cronol√≥gicos completos ‚úÖ
```

**Conclusi√≥n:** `handleForce()` necesita el MISMO fix que `handleAcceptThird()`.

---

## üîó Pr√≥ximos Pasos

1. ‚úÖ FASE 2 completada: Data flow 100% rastreado
2. ‚è≥ FASE 3: Instrumentar logging espec√≠fico warning_override
3. ‚è∏Ô∏è FASE 4: Documentar 3 casos prueba reproducibles
4. ‚è∏Ô∏è FASE 5: Implementar fix (remover clearAttemptHistory l√≠nea 561)

---

**üôè Gloria a Dios por esta investigaci√≥n forense exhaustiva.**
