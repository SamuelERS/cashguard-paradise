# 6. ARQUITECTURA T√âCNICA - OPCI√ìN B DETALLADA

**Caso de Negocio:** L√≥gica de Env√≠os/Delivery
**Documento:** 6 de 9 - Arquitectura T√©cnica
**Fecha:** 23 Octubre 2025
**Autor:** Claude (IA) + Samuel Rodr√≠guez (Paradise System Labs)

---

## üìã TABLA DE CONTENIDOS

1. [Resumen Arquitect√≥nico](#resumen-arquitect√≥nico)
2. [TypeScript Interfaces Completas](#typescript-interfaces-completas)
3. [Componentes React](#componentes-react)
4. [Helpers y Utilidades](#helpers-y-utilidades)
5. [localStorage Strategy](#localstorage-strategy)
6. [Data Flow Completo](#data-flow-completo)
7. [Sistema de Alertas](#sistema-de-alertas)
8. [Reporte WhatsApp](#reporte-whatsapp)
9. [Testing Strategy](#testing-strategy)
10. [Performance Considerations](#performance-considerations)

---

## üìä RESUMEN ARQUITECT√ìNICO

### Stack Tecnol√≥gico

**Frontend:**
- ‚úÖ React 18+ (TypeScript strict mode)
- ‚úÖ Vite 5+ (build tooling)
- ‚úÖ shadcn/ui (componentes base)
- ‚úÖ Tailwind CSS (styling)
- ‚úÖ Framer Motion (animaciones)
- ‚úÖ Lucide React (iconos)

**State Management:**
- ‚úÖ localStorage (persistencia local)
- ‚úÖ React hooks (useState, useCallback, useMemo)
- ‚úÖ Custom hooks (useDeliveries, useDeliveryAlerts)

**Testing:**
- ‚úÖ Vitest (unit + integration)
- ‚úÖ Testing Library React (componentes)
- ‚úÖ TIER 0 tests (cross-validation matem√°tica)

### Estructura de Carpetas

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ deliveries/                    // NUEVO - M√≥dulo completo
‚îÇ       ‚îú‚îÄ‚îÄ DeliveryManager.tsx        // Formulario + lista d√≠a
‚îÇ       ‚îú‚îÄ‚îÄ DeliveryDashboard.tsx      // Dashboard acumulado
‚îÇ       ‚îú‚îÄ‚îÄ DeliveryDetailsModal.tsx   // Modal detalles env√≠o
‚îÇ       ‚îú‚îÄ‚îÄ DeliveryAlertBadge.tsx     // Badge d√≠as pendiente
‚îÇ       ‚îî‚îÄ‚îÄ DeliveryEducationModal.tsx // Modal educativo
‚îÇ
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useDeliveries.ts               // NUEVO - CRUD deliveries
‚îÇ   ‚îú‚îÄ‚îÄ useDeliveryAlerts.ts           // NUEVO - Sistema alertas
‚îÇ   ‚îî‚îÄ‚îÄ useDeliverySummary.ts          // NUEVO - C√°lculo resumen
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ deliveryCalculation.ts         // NUEVO - Helpers c√°lculo
‚îÇ   ‚îú‚îÄ‚îÄ deliveryValidation.ts          // NUEVO - Type guards
‚îÇ   ‚îî‚îÄ‚îÄ deliveryFormatters.ts          // NUEVO - Format WhatsApp
‚îÇ
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ deliveries.ts                  // NUEVO - Interfaces completas
‚îÇ
‚îî‚îÄ‚îÄ data/
    ‚îî‚îÄ‚îÄ deliveryConfig.ts              // NUEVO - Constants + config

tests/
‚îî‚îÄ‚îÄ deliveries/                        // NUEVO - Suite completa
    ‚îú‚îÄ‚îÄ DeliveryManager.test.tsx       // 20-25 tests
    ‚îú‚îÄ‚îÄ DeliveryDashboard.test.tsx     // 25-30 tests
    ‚îú‚îÄ‚îÄ useDeliveries.test.ts          // 15-20 tests
    ‚îú‚îÄ‚îÄ deliveryCalculation.test.ts    // TIER 0 obligatorio
    ‚îî‚îÄ‚îÄ deliveryIntegration.test.tsx   // E2E flows
```

---

## üîß TYPESCRIPT INTERFACES COMPLETAS

### types/deliveries.ts

```typescript
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIPOS BASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Courier/Encomiendista que maneja el env√≠o
 */
export type CourierType = 'C807' | 'Melos' | 'Otro';

/**
 * Estado del env√≠o en su ciclo de vida
 */
export type DeliveryStatus =
  | 'pending_cod'       // Pendiente cobro cliente (estado inicial)
  | 'paid'              // Cobrado y depositado por courier
  | 'cancelled'         // Cancelado (cliente rechaz√≥)
  | 'rejected';         // Rechazado/perdido (no entregado)

/**
 * Nivel de alerta seg√∫n d√≠as pendiente
 */
export type AlertLevel = 'ok' | 'warning' | 'urgent' | 'critical';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFACE PRINCIPAL: DeliveryEntry
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Representa un env√≠o individual registrado en CashGuard
 *
 * @remarks
 * - Se crea cuando cajero despacha env√≠o
 * - Persiste en localStorage hasta marcar como cobrado/cancelado
 * - ID √∫nico permite trackear a trav√©s del tiempo
 * - Timestamps ISO 8601 para correlaci√≥n temporal precisa
 *
 * @example
 * ```typescript
 * const delivery: DeliveryEntry = {
 *   id: "uuid-1234-5678-9abc-def0",
 *   customerName: "Carlos G√≥mez",
 *   amount: 113.00,
 *   courier: "C807",
 *   guideNumber: "APA-1832-202510230001",
 *   invoiceNumber: "12347",
 *   status: "pending_cod",
 *   createdAt: "2025-10-23T14:32:18-06:00",
 *   notes: "Acuario 50L Santa Ana"
 * };
 * ```
 */
export interface DeliveryEntry {
  /** UUID v4 √∫nico del env√≠o */
  id: string;

  /** Nombre completo cliente destinatario (3-100 caracteres) */
  customerName: string;

  /** Monto total env√≠o USD ($0.01 - $10,000.00) */
  amount: number;

  /** Courier que maneja el env√≠o */
  courier: CourierType;

  /** N√∫mero gu√≠a courier (formato var√≠a por courier) */
  guideNumber?: string;

  /** N√∫mero factura SICAR asociada */
  invoiceNumber?: string;

  /** Estado actual del env√≠o */
  status: DeliveryStatus;

  /** Timestamp ISO 8601 cuando se cre√≥ el env√≠o */
  createdAt: string;

  /** Timestamp ISO 8601 cuando se marc√≥ como cobrado */
  paidAt?: string;

  /** Timestamp ISO 8601 cuando se cancel√≥ */
  cancelledAt?: string;

  /** Motivo cancelaci√≥n (requerido si status = cancelled/rejected) */
  cancelReason?: string;

  /** Notas adicionales del cajero (opcional, max 500 chars) */
  notes?: string;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFACE RESUMEN: DeliverySummary
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Resumen agregado de env√≠os para dashboard
 *
 * @remarks
 * - Calculado en tiempo real desde deliveries_pending
 * - Usado para reporte WhatsApp + dashboard UI
 * - M√©tricas por courier para an√°lisis performance
 *
 * @example
 * ```typescript
 * const summary: DeliverySummary = {
 *   totalPending: 1245.00,
 *   countPending: 12,
 *   byCourier: {
 *     C807: { total: 800, count: 8 },
 *     Melos: { total: 445, count: 4 },
 *     Otro: { total: 0, count: 0 }
 *   },
 *   alerts: {
 *     warning7Days: 2,
 *     urgent15Days: 1,
 *     critical30Days: 0
 *   }
 * };
 * ```
 */
export interface DeliverySummary {
  /** Suma total USD env√≠os pendientes */
  totalPending: number;

  /** Cantidad env√≠os pendientes */
  countPending: number;

  /** Agregaci√≥n por courier */
  byCourier: {
    C807: { total: number; count: number };
    Melos: { total: number; count: number };
    Otro: { total: number; count: number };
  };

  /** Contadores alertas por nivel */
  alerts: {
    warning7Days: number;    // 7-14 d√≠as pendiente
    urgent15Days: number;    // 15-29 d√≠as pendiente
    critical30Days: number;  // 30+ d√≠as pendiente
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFACE DASHBOARD: DeliveryDashboardData
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Datos completos para renderizar dashboard
 *
 * @remarks
 * - Incluye lista completa + resumen agregado
 * - Ordenado por d√≠as pendiente (cr√≠ticos primero)
 * - Usado por DeliveryDashboard.tsx
 */
export interface DeliveryDashboardData {
  /** Lista env√≠os pendientes (ordenado d√≠as desc) */
  pending: DeliveryEntry[];

  /** Resumen agregado m√©tricas */
  summary: DeliverySummary;

  /** Timestamp √∫ltima actualizaci√≥n */
  lastUpdated: string;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTERFACE FILTROS: DeliveryFilters
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Filtros disponibles para dashboard
 */
export interface DeliveryFilters {
  /** Filtrar por courier espec√≠fico */
  courier?: CourierType | 'all';

  /** Filtrar por rango fechas */
  dateRange?: {
    from: string;  // ISO 8601
    to: string;    // ISO 8601
  };

  /** Filtrar por nivel alerta */
  alertLevel?: AlertLevel | 'all';

  /** B√∫squeda texto (cliente, gu√≠a, factura) */
  searchQuery?: string;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TYPE GUARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Valida si objeto es DeliveryEntry v√°lido
 *
 * @remarks
 * - Usa runtime validation completa
 * - Valida tipos + constraints (amount > 0, etc.)
 * - Safe para deserializaci√≥n localStorage
 *
 * @example
 * ```typescript
 * const data = JSON.parse(localStorage.getItem('deliveries'));
 * if (Array.isArray(data) && data.every(isDeliveryEntry)) {
 *   // Type-safe: data is DeliveryEntry[]
 * }
 * ```
 */
export function isDeliveryEntry(obj: unknown): obj is DeliveryEntry {
  if (typeof obj !== 'object' || obj === null) return false;

  const entry = obj as Partial<DeliveryEntry>;

  // Validar campos requeridos
  if (typeof entry.id !== 'string' || entry.id.length === 0) return false;
  if (typeof entry.customerName !== 'string' ||
      entry.customerName.length < 3 ||
      entry.customerName.length > 100) return false;
  if (typeof entry.amount !== 'number' ||
      entry.amount <= 0 ||
      entry.amount > 10000) return false;
  if (!['C807', 'Melos', 'Otro'].includes(entry.courier as string)) return false;
  if (!['pending_cod', 'paid', 'cancelled', 'rejected'].includes(entry.status as string)) return false;
  if (typeof entry.createdAt !== 'string') return false;

  // Validar timestamp parseable
  const created = new Date(entry.createdAt);
  if (isNaN(created.getTime())) return false;

  // Validar campos opcionales si existen
  if (entry.guideNumber !== undefined && typeof entry.guideNumber !== 'string') return false;
  if (entry.invoiceNumber !== undefined && typeof entry.invoiceNumber !== 'string') return false;
  if (entry.paidAt !== undefined) {
    if (typeof entry.paidAt !== 'string') return false;
    const paid = new Date(entry.paidAt);
    if (isNaN(paid.getTime())) return false;
  }
  if (entry.cancelledAt !== undefined) {
    if (typeof entry.cancelledAt !== 'string') return false;
    const cancelled = new Date(entry.cancelledAt);
    if (isNaN(cancelled.getTime())) return false;
  }
  if (entry.cancelReason !== undefined && typeof entry.cancelReason !== 'string') return false;
  if (entry.notes !== undefined &&
      (typeof entry.notes !== 'string' || entry.notes.length > 500)) return false;

  return true;
}

/**
 * Valida si courier string es CourierType v√°lido
 */
export function isValidCourier(value: string): value is CourierType {
  return ['C807', 'Melos', 'Otro'].includes(value);
}

/**
 * Valida si status string es DeliveryStatus v√°lido
 */
export function isValidStatus(value: string): value is DeliveryStatus {
  return ['pending_cod', 'paid', 'cancelled', 'rejected'].includes(value);
}
```

---

## ‚öõÔ∏è COMPONENTES REACT

### 1. DeliveryManager.tsx (Formulario + Lista D√≠a)

```typescript
/**
 * Componente principal para registrar env√≠os del d√≠a
 *
 * Funcionalidad:
 * - Formulario registro nuevo env√≠o
 * - Lista env√≠os registrados hoy
 * - Editar/eliminar antes de corte nocturno
 * - Validaci√≥n campos obligatorios
 *
 * Props:
 * - onDeliveriesChange: Callback cuando lista cambia
 * - initialDeliveries: Env√≠os precargados (opcional)
 */

import React, { useState, useCallback } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { Plus, Edit2, Trash2, AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/ui/select';
import { Label } from '@/components/ui/label';
import type { DeliveryEntry, CourierType } from '@/types/deliveries';
import { DELIVERY_VALIDATION } from '@/data/deliveryConfig';
import { formatCurrency } from '@/utils/formatters';

interface DeliveryManagerProps {
  onDeliveriesChange?: (deliveries: DeliveryEntry[]) => void;
  initialDeliveries?: DeliveryEntry[];
}

export const DeliveryManager: React.FC<DeliveryManagerProps> = ({
  onDeliveriesChange,
  initialDeliveries = []
}) => {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // STATE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const [deliveries, setDeliveries] = useState<DeliveryEntry[]>(initialDeliveries);
  const [isFormOpen, setIsFormOpen] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);

  // Form fields
  const [customerName, setCustomerName] = useState('');
  const [amount, setAmount] = useState('');
  const [courier, setCourier] = useState<CourierType>('C807');
  const [guideNumber, setGuideNumber] = useState('');
  const [invoiceNumber, setInvoiceNumber] = useState('');
  const [notes, setNotes] = useState('');

  // Validation errors
  const [errors, setErrors] = useState<Record<string, string>>({});

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // VALIDATION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const validateForm = useCallback((): boolean => {
    const newErrors: Record<string, string> = {};

    // Cliente requerido (3-100 chars)
    if (customerName.trim().length < 3) {
      newErrors.customerName = 'M√≠nimo 3 caracteres';
    } else if (customerName.trim().length > 100) {
      newErrors.customerName = 'M√°ximo 100 caracteres';
    }

    // Monto requerido ($0.01 - $10,000)
    const amountNum = parseFloat(amount);
    if (isNaN(amountNum) || amountNum <= 0) {
      newErrors.amount = 'Monto debe ser mayor a $0.00';
    } else if (amountNum > DELIVERY_VALIDATION.MAX_AMOUNT) {
      newErrors.amount = `M√°ximo $${DELIVERY_VALIDATION.MAX_AMOUNT.toFixed(2)}`;
    }

    // Notas opcional (max 500 chars)
    if (notes.length > 500) {
      newErrors.notes = 'M√°ximo 500 caracteres';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [customerName, amount, notes]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // HANDLERS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const handleSubmit = useCallback((e: React.FormEvent) => {
    e.preventDefault();

    if (!validateForm()) return;

    const newDelivery: DeliveryEntry = {
      id: editingId || uuidv4(),
      customerName: customerName.trim(),
      amount: parseFloat(amount),
      courier,
      guideNumber: guideNumber.trim() || undefined,
      invoiceNumber: invoiceNumber.trim() || undefined,
      status: 'pending_cod',
      createdAt: new Date().toISOString(),
      notes: notes.trim() || undefined
    };

    let updatedDeliveries: DeliveryEntry[];
    if (editingId) {
      // Editar existente
      updatedDeliveries = deliveries.map(d =>
        d.id === editingId ? newDelivery : d
      );
    } else {
      // Agregar nuevo
      updatedDeliveries = [...deliveries, newDelivery];
    }

    setDeliveries(updatedDeliveries);
    onDeliveriesChange?.(updatedDeliveries);

    // Reset form
    resetForm();
  }, [
    customerName,
    amount,
    courier,
    guideNumber,
    invoiceNumber,
    notes,
    editingId,
    deliveries,
    onDeliveriesChange,
    validateForm
  ]);

  const handleEdit = useCallback((delivery: DeliveryEntry) => {
    setEditingId(delivery.id);
    setCustomerName(delivery.customerName);
    setAmount(delivery.amount.toString());
    setCourier(delivery.courier);
    setGuideNumber(delivery.guideNumber || '');
    setInvoiceNumber(delivery.invoiceNumber || '');
    setNotes(delivery.notes || '');
    setIsFormOpen(true);
  }, []);

  const handleDelete = useCallback((id: string) => {
    const updatedDeliveries = deliveries.filter(d => d.id !== id);
    setDeliveries(updatedDeliveries);
    onDeliveriesChange?.(updatedDeliveries);
  }, [deliveries, onDeliveriesChange]);

  const resetForm = useCallback(() => {
    setCustomerName('');
    setAmount('');
    setCourier('C807');
    setGuideNumber('');
    setInvoiceNumber('');
    setNotes('');
    setErrors({});
    setEditingId(null);
    setIsFormOpen(false);
  }, []);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">Env√≠os del D√≠a</h3>
        <Button
          onClick={() => setIsFormOpen(true)}
          variant="default"
          size="sm"
        >
          <Plus className="w-4 h-4 mr-2" />
          Registrar Env√≠o
        </Button>
      </div>

      {/* Formulario (Collapsible) */}
      {isFormOpen && (
        <form onSubmit={handleSubmit} className="space-y-4 p-4 border rounded-lg">
          <div className="grid grid-cols-2 gap-4">
            {/* Cliente */}
            <div className="col-span-2">
              <Label htmlFor="customerName">Cliente *</Label>
              <Input
                id="customerName"
                value={customerName}
                onChange={e => setCustomerName(e.target.value)}
                placeholder="Nombre completo destinatario"
                className={errors.customerName ? 'border-red-500' : ''}
              />
              {errors.customerName && (
                <p className="text-sm text-red-500 mt-1">{errors.customerName}</p>
              )}
            </div>

            {/* Monto */}
            <div>
              <Label htmlFor="amount">Monto USD *</Label>
              <Input
                id="amount"
                type="number"
                step="0.01"
                value={amount}
                onChange={e => setAmount(e.target.value)}
                placeholder="0.00"
                className={errors.amount ? 'border-red-500' : ''}
              />
              {errors.amount && (
                <p className="text-sm text-red-500 mt-1">{errors.amount}</p>
              )}
            </div>

            {/* Courier */}
            <div>
              <Label htmlFor="courier">Courier *</Label>
              <Select
                value={courier}
                onValueChange={(value) => setCourier(value as CourierType)}
              >
                <option value="C807">C807 Express</option>
                <option value="Melos">Melos</option>
                <option value="Otro">Otro</option>
              </Select>
            </div>

            {/* Gu√≠a */}
            <div>
              <Label htmlFor="guideNumber">Gu√≠a # (opcional)</Label>
              <Input
                id="guideNumber"
                value={guideNumber}
                onChange={e => setGuideNumber(e.target.value)}
                placeholder="APA-1832-..."
              />
            </div>

            {/* Factura SICAR */}
            <div>
              <Label htmlFor="invoiceNumber">Factura SICAR (opcional)</Label>
              <Input
                id="invoiceNumber"
                value={invoiceNumber}
                onChange={e => setInvoiceNumber(e.target.value)}
                placeholder="#12347"
              />
            </div>

            {/* Notas */}
            <div className="col-span-2">
              <Label htmlFor="notes">Notas (opcional)</Label>
              <Input
                id="notes"
                value={notes}
                onChange={e => setNotes(e.target.value)}
                placeholder="Acuario 50L Santa Ana..."
                className={errors.notes ? 'border-red-500' : ''}
              />
              {errors.notes && (
                <p className="text-sm text-red-500 mt-1">{errors.notes}</p>
              )}
            </div>
          </div>

          {/* Botones */}
          <div className="flex gap-2 justify-end">
            <Button type="button" variant="ghost" onClick={resetForm}>
              Cancelar
            </Button>
            <Button type="submit" variant="default">
              {editingId ? 'Actualizar' : 'Registrar'}
            </Button>
          </div>
        </form>
      )}

      {/* Lista Env√≠os Hoy */}
      {deliveries.length > 0 ? (
        <div className="space-y-2">
          {deliveries.map(delivery => (
            <div
              key={delivery.id}
              className="flex items-center justify-between p-3 border rounded-lg hover:bg-accent"
            >
              <div className="flex-1">
                <p className="font-medium">{delivery.customerName}</p>
                <p className="text-sm text-muted-foreground">
                  {delivery.courier}
                  {delivery.guideNumber && ` ‚Ä¢ ${delivery.guideNumber}`}
                  {delivery.invoiceNumber && ` ‚Ä¢ Fact ${delivery.invoiceNumber}`}
                </p>
              </div>
              <div className="flex items-center gap-3">
                <span className="font-semibold">{formatCurrency(delivery.amount)}</span>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleEdit(delivery)}
                >
                  <Edit2 className="w-4 h-4" />
                </Button>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleDelete(delivery.id)}
                  className="text-red-500"
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>
            </div>
          ))}

          {/* Total */}
          <div className="flex justify-between items-center p-3 bg-accent rounded-lg">
            <span className="font-semibold">Total Env√≠os Hoy:</span>
            <span className="text-lg font-bold">
              {formatCurrency(deliveries.reduce((sum, d) => sum + d.amount, 0))}
            </span>
          </div>
        </div>
      ) : (
        <div className="text-center py-8 text-muted-foreground">
          <AlertCircle className="w-12 h-12 mx-auto mb-2 opacity-50" />
          <p>No hay env√≠os registrados hoy</p>
          <p className="text-sm">Click "Registrar Env√≠o" para agregar uno</p>
        </div>
      )}
    </div>
  );
};
```

### 2. DeliveryDashboard.tsx (Dashboard Acumulado)

```typescript
/**
 * Dashboard env√≠os pendientes acumulados
 *
 * Funcionalidad:
 * - Vista tabla todos env√≠os pendientes
 * - Resumen ejecutivo (totales, alertas)
 * - Filtros (courier, fecha, b√∫squeda)
 * - Ordenamiento (fecha, monto, d√≠as)
 * - Modal detalles + acciones (marcar cobrado, cancelar)
 *
 * Props:
 * - requirePin: Si true, solicita PIN supervisor antes mostrar
 */

import React, { useState, useMemo, useCallback } from 'react';
import { Search, Filter, Download, Calendar } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { DeliveryAlertBadge } from './DeliveryAlertBadge';
import { DeliveryDetailsModal } from './DeliveryDetailsModal';
import { useDeliveries } from '@/hooks/useDeliveries';
import { useDeliverySummary } from '@/hooks/useDeliverySummary';
import { getDaysPending } from '@/utils/deliveryCalculation';
import { formatCurrency, formatDate } from '@/utils/formatters';
import type { DeliveryEntry, DeliveryFilters, CourierType } from '@/types/deliveries';

interface DeliveryDashboardProps {
  requirePin?: boolean;
}

export const DeliveryDashboard: React.FC<DeliveryDashboardProps> = ({
  requirePin = true
}) => {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // HOOKS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const { pending, markAsPaid, cancelDelivery } = useDeliveries();
  const summary = useDeliverySummary(pending);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // STATE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const [filters, setFilters] = useState<DeliveryFilters>({
    courier: 'all',
    searchQuery: ''
  });

  const [sortBy, setSortBy] = useState<'days' | 'amount' | 'date'>('days');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');
  const [selectedDelivery, setSelectedDelivery] = useState<DeliveryEntry | null>(null);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // COMPUTED
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const filteredDeliveries = useMemo(() => {
    let filtered = [...pending];

    // Filtro courier
    if (filters.courier && filters.courier !== 'all') {
      filtered = filtered.filter(d => d.courier === filters.courier);
    }

    // Filtro b√∫squeda
    if (filters.searchQuery) {
      const query = filters.searchQuery.toLowerCase();
      filtered = filtered.filter(d =>
        d.customerName.toLowerCase().includes(query) ||
        d.guideNumber?.toLowerCase().includes(query) ||
        d.invoiceNumber?.toLowerCase().includes(query)
      );
    }

    // Ordenamiento
    filtered.sort((a, b) => {
      let comparison = 0;

      switch (sortBy) {
        case 'days':
          comparison = getDaysPending(a.createdAt) - getDaysPending(b.createdAt);
          break;
        case 'amount':
          comparison = a.amount - b.amount;
          break;
        case 'date':
          comparison = new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
          break;
      }

      return sortOrder === 'desc' ? -comparison : comparison;
    });

    return filtered;
  }, [pending, filters, sortBy, sortOrder]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // HANDLERS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const handleExportCSV = useCallback(() => {
    const csv = [
      ['Fecha', 'Cliente', 'Courier', 'Gu√≠a', 'Monto', 'D√≠as', 'Factura'].join(','),
      ...filteredDeliveries.map(d =>
        [
          formatDate(d.createdAt),
          `"${d.customerName}"`,
          d.courier,
          d.guideNumber || '',
          d.amount.toFixed(2),
          getDaysPending(d.createdAt),
          d.invoiceNumber || ''
        ].join(',')
      )
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `envios-pendientes-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  }, [filteredDeliveries]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  return (
    <div className="space-y-6">
      {/* Resumen Ejecutivo */}
      <div className="grid grid-cols-3 gap-4">
        <div className="p-4 border rounded-lg">
          <p className="text-sm text-muted-foreground">Total Pendiente</p>
          <p className="text-2xl font-bold">{formatCurrency(summary.totalPending)}</p>
          <p className="text-sm text-muted-foreground">{summary.countPending} env√≠os</p>
        </div>

        <div className="p-4 border rounded-lg">
          <p className="text-sm text-muted-foreground">C807 Express</p>
          <p className="text-2xl font-bold">{formatCurrency(summary.byCourier.C807.total)}</p>
          <p className="text-sm text-muted-foreground">{summary.byCourier.C807.count} env√≠os</p>
        </div>

        <div className="p-4 border rounded-lg">
          <p className="text-sm text-muted-foreground">Melos</p>
          <p className="text-2xl font-bold">{formatCurrency(summary.byCourier.Melos.total)}</p>
          <p className="text-sm text-muted-foreground">{summary.byCourier.Melos.count} env√≠os</p>
        </div>
      </div>

      {/* Alertas */}
      {(summary.alerts.warning7Days > 0 ||
        summary.alerts.urgent15Days > 0 ||
        summary.alerts.critical30Days > 0) && (
        <div className="p-4 border border-yellow-500 rounded-lg bg-yellow-50">
          <p className="font-semibold mb-2">‚ö†Ô∏è Alertas Pendientes:</p>
          <div className="grid grid-cols-3 gap-2 text-sm">
            {summary.alerts.warning7Days > 0 && (
              <p>üü° 7+ d√≠as: {summary.alerts.warning7Days} env√≠os</p>
            )}
            {summary.alerts.urgent15Days > 0 && (
              <p>üî¥ 15+ d√≠as: {summary.alerts.urgent15Days} env√≠os</p>
            )}
            {summary.alerts.critical30Days > 0 && (
              <p>üö® 30+ d√≠as: {summary.alerts.critical30Days} env√≠os</p>
            )}
          </div>
        </div>
      )}

      {/* Filtros */}
      <div className="flex gap-4">
        <div className="flex-1">
          <Input
            placeholder="Buscar cliente, gu√≠a, factura..."
            value={filters.searchQuery || ''}
            onChange={e => setFilters(f => ({ ...f, searchQuery: e.target.value }))}
            icon={<Search className="w-4 h-4" />}
          />
        </div>

        <select
          className="px-3 py-2 border rounded-md"
          value={filters.courier || 'all'}
          onChange={e => setFilters(f => ({ ...f, courier: e.target.value as CourierType | 'all' }))}
        >
          <option value="all">Todos los couriers</option>
          <option value="C807">C807 Express</option>
          <option value="Melos">Melos</option>
          <option value="Otro">Otro</option>
        </select>

        <Button variant="outline" onClick={handleExportCSV}>
          <Download className="w-4 h-4 mr-2" />
          Export CSV
        </Button>
      </div>

      {/* Tabla */}
      <div className="border rounded-lg overflow-hidden">
        <table className="w-full">
          <thead className="bg-accent">
            <tr>
              <th className="p-3 text-left">Fecha</th>
              <th className="p-3 text-left">Cliente</th>
              <th className="p-3 text-left">Courier</th>
              <th className="p-3 text-left">Gu√≠a</th>
              <th className="p-3 text-right">Monto</th>
              <th className="p-3 text-center">D√≠as</th>
              <th className="p-3 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {filteredDeliveries.map(delivery => (
              <tr
                key={delivery.id}
                className="border-t hover:bg-accent cursor-pointer"
                onClick={() => setSelectedDelivery(delivery)}
              >
                <td className="p-3">{formatDate(delivery.createdAt)}</td>
                <td className="p-3">{delivery.customerName}</td>
                <td className="p-3">{delivery.courier}</td>
                <td className="p-3 text-sm text-muted-foreground">
                  {delivery.guideNumber || '-'}
                </td>
                <td className="p-3 text-right font-semibold">
                  {formatCurrency(delivery.amount)}
                </td>
                <td className="p-3 text-center">
                  <DeliveryAlertBadge delivery={delivery} />
                </td>
                <td className="p-3 text-center">
                  <Button variant="ghost" size="sm">
                    Ver
                  </Button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {filteredDeliveries.length === 0 && (
          <div className="text-center py-8 text-muted-foreground">
            <p>No hay env√≠os pendientes</p>
          </div>
        )}
      </div>

      {/* Modal Detalles */}
      {selectedDelivery && (
        <DeliveryDetailsModal
          delivery={selectedDelivery}
          onClose={() => setSelectedDelivery(null)}
          onMarkPaid={markAsPaid}
          onCancel={cancelDelivery}
        />
      )}
    </div>
  );
};
```

**Continuar√© con los helpers, hooks y el resto de la arquitectura...**

---

## üîß HELPERS Y UTILIDADES

### utils/deliveryCalculation.ts

```typescript
/**
 * Helpers c√°lculo env√≠os
 */

import type { DeliveryEntry, DeliverySummary } from '@/types/deliveries';

/**
 * Calcula d√≠as transcurridos desde env√≠o
 *
 * @param createdAt - Timestamp ISO 8601 cuando se cre√≥
 * @returns N√∫mero entero d√≠as pendiente
 *
 * @example
 * ```typescript
 * getDaysPending("2025-10-15T14:32:18Z") // Hoy 23 Oct ‚Üí 8 d√≠as
 * ```
 */
export function getDaysPending(createdAt: string): number {
  const created = new Date(createdAt);
  const now = new Date();
  const diffMs = now.getTime() - created.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays); // Nunca negativo
}

/**
 * Determina nivel alerta seg√∫n d√≠as pendiente
 */
export function getAlertLevel(days: number): AlertLevel {
  if (days >= 30) return 'critical';
  if (days >= 15) return 'urgent';
  if (days >= 7) return 'warning';
  return 'ok';
}

/**
 * Construye resumen agregado desde lista env√≠os
 */
export function buildDeliverySummary(
  pending: DeliveryEntry[]
): DeliverySummary {
  const summary: DeliverySummary = {
    totalPending: 0,
    countPending: pending.length,
    byCourier: {
      C807: { total: 0, count: 0 },
      Melos: { total: 0, count: 0 },
      Otro: { total: 0, count: 0 }
    },
    alerts: {
      warning7Days: 0,
      urgent15Days: 0,
      critical30Days: 0
    }
  };

  pending.forEach(delivery => {
    // Total general
    summary.totalPending += delivery.amount;

    // Por courier
    summary.byCourier[delivery.courier].total += delivery.amount;
    summary.byCourier[delivery.courier].count += 1;

    // Alertas
    const days = getDaysPending(delivery.createdAt);
    if (days >= 30) {
      summary.alerts.critical30Days += 1;
    } else if (days >= 15) {
      summary.alerts.urgent15Days += 1;
    } else if (days >= 7) {
      summary.alerts.warning7Days += 1;
    }
  });

  return summary;
}

/**
 * Ajusta SICAR esperado restando env√≠os pendientes
 */
export function adjustSICAR(
  sicarTotal: number,
  electronicPayments: number,
  deliveries: DeliveryEntry[]
): number {
  const deliveryTotal = deliveries.reduce(
    (sum, d) => sum + d.amount,
    0
  );

  return sicarTotal - electronicPayments - deliveryTotal;
}
```

---

---

## üíæ LOCALSTORAGE STRATEGY

### Claves y Estructura

**Naming Convention:**
```typescript
// data/deliveryConfig.ts

export const STORAGE_KEYS = {
  PENDING: 'cashguard_deliveries_pending',     // Env√≠os pendientes cobro
  HISTORY: 'cashguard_deliveries_history',     // Hist√≥rico (cobrados + cancelados)
  LAST_CLEANUP: 'cashguard_deliveries_cleanup' // Timestamp √∫ltima limpieza
} as const;

export const DELIVERY_VALIDATION = {
  MIN_CUSTOMER_NAME: 3,
  MAX_CUSTOMER_NAME: 100,
  MIN_AMOUNT: 0.01,
  MAX_AMOUNT: 10000,
  MAX_NOTES: 500,
  HISTORY_RETENTION_DAYS: 90  // Retener hist√≥rico 3 meses
} as const;
```

### Data Structure en localStorage

**Estructura JSON:**
```typescript
// cashguard_deliveries_pending
{
  "version": "1.0",
  "lastUpdated": "2025-10-23T14:32:18-06:00",
  "deliveries": [
    {
      "id": "uuid-1234-5678",
      "customerName": "Carlos G√≥mez",
      "amount": 113.00,
      "courier": "C807",
      "guideNumber": "APA-1832-202510230001",
      "invoiceNumber": "12347",
      "status": "pending_cod",
      "createdAt": "2025-10-23T14:32:18-06:00",
      "notes": "Acuario 50L Santa Ana"
    }
    // ... m√°s deliveries
  ]
}

// cashguard_deliveries_history
{
  "version": "1.0",
  "entries": [
    {
      "id": "uuid-9999-8888",
      "customerName": "Mar√≠a L√≥pez",
      "amount": 84.75,
      "courier": "Melos",
      "status": "paid",
      "createdAt": "2025-10-15T09:15:00-06:00",
      "paidAt": "2025-10-20T14:00:00-06:00"
      // ... resto de campos
    }
  ]
}

// cashguard_deliveries_cleanup
{
  "lastCleanupDate": "2025-10-23T00:00:00-06:00"
}
```

### Persistence Patterns

**1. Save on Change (Debounced)**
```typescript
// hooks/useDeliveries.ts (fragmento)

import { debounce } from 'lodash-es';

const saveToStorage = useCallback(
  debounce((deliveries: DeliveryEntry[]) => {
    try {
      const data = {
        version: '1.0',
        lastUpdated: new Date().toISOString(),
        deliveries
      };
      localStorage.setItem(
        STORAGE_KEYS.PENDING,
        JSON.stringify(data)
      );
    } catch (error) {
      console.error('[useDeliveries] Error saving to localStorage:', error);
      // Mostrar toast error al usuario
    }
  }, 500), // Debounce 500ms
  []
);

const addDelivery = useCallback((delivery: DeliveryEntry) => {
  const updated = [...pending, delivery];
  setPending(updated);
  saveToStorage(updated); // Guarda despu√©s de 500ms sin cambios
}, [pending, saveToStorage]);
```

**2. Load on Mount (with Validation)**
```typescript
const loadFromStorage = useCallback((): DeliveryEntry[] => {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.PENDING);
    if (!raw) return [];

    const data = JSON.parse(raw);

    // Validar version
    if (data.version !== '1.0') {
      console.warn('[useDeliveries] Unsupported version:', data.version);
      return [];
    }

    // Validar cada delivery con type guard
    if (!Array.isArray(data.deliveries)) return [];
    const validated = data.deliveries.filter(isDeliveryEntry);

    // Log si hubo deliveries inv√°lidas filtradas
    if (validated.length !== data.deliveries.length) {
      console.warn(
        `[useDeliveries] Filtered ${data.deliveries.length - validated.length} invalid deliveries`
      );
    }

    return validated;
  } catch (error) {
    console.error('[useDeliveries] Error loading from localStorage:', error);
    return [];
  }
}, []);

useEffect(() => {
  const loaded = loadFromStorage();
  setPending(loaded);
}, []); // Solo al montar
```

### Data Migration Strategy

**Versionado y Migraciones:**
```typescript
// utils/deliveryMigrations.ts

type StorageVersion = '1.0' | '1.1' | '2.0';

interface MigrationFn {
  from: StorageVersion;
  to: StorageVersion;
  migrate: (data: any) => any;
}

const MIGRATIONS: MigrationFn[] = [
  // Ejemplo: Migraci√≥n hipot√©tica 1.0 ‚Üí 1.1
  {
    from: '1.0',
    to: '1.1',
    migrate: (data) => {
      // Agregar campo nuevo 'priority' a cada delivery
      return {
        ...data,
        version: '1.1',
        deliveries: data.deliveries.map((d: any) => ({
          ...d,
          priority: 'normal' // Default para datos antiguos
        }))
      };
    }
  }
];

export function migrateStorageData(
  raw: string,
  currentVersion: StorageVersion
): any {
  let data = JSON.parse(raw);
  let version = data.version as StorageVersion;

  // Aplicar migraciones secuencialmente
  while (version !== currentVersion) {
    const migration = MIGRATIONS.find(m => m.from === version);
    if (!migration) {
      throw new Error(`No migration path from ${version} to ${currentVersion}`);
    }
    data = migration.migrate(data);
    version = migration.to;
  }

  return data;
}
```

### Cleanup Old Data Logic

**Limpieza Autom√°tica Hist√≥rico:**
```typescript
// hooks/useDeliveries.ts (fragmento)

const cleanupHistory = useCallback(async () => {
  try {
    const lastCleanup = localStorage.getItem(STORAGE_KEYS.LAST_CLEANUP);
    const now = new Date();

    // Solo limpiar una vez al d√≠a
    if (lastCleanup) {
      const lastCleanupDate = new Date(JSON.parse(lastCleanup).lastCleanupDate);
      const hoursSinceCleanup = (now.getTime() - lastCleanupDate.getTime()) / (1000 * 60 * 60);
      if (hoursSinceCleanup < 24) {
        return; // Ya se limpi√≥ hoy
      }
    }

    // Cargar hist√≥rico
    const historyRaw = localStorage.getItem(STORAGE_KEYS.HISTORY);
    if (!historyRaw) return;

    const history = JSON.parse(historyRaw);
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - DELIVERY_VALIDATION.HISTORY_RETENTION_DAYS);

    // Filtrar entries m√°s antiguos que retention period
    const filtered = history.entries.filter((entry: DeliveryEntry) => {
      const entryDate = new Date(entry.paidAt || entry.cancelledAt || entry.createdAt);
      return entryDate > cutoffDate;
    });

    // Guardar hist√≥rico limpio
    localStorage.setItem(
      STORAGE_KEYS.HISTORY,
      JSON.stringify({
        version: '1.0',
        entries: filtered
      })
    );

    // Registrar √∫ltima limpieza
    localStorage.setItem(
      STORAGE_KEYS.LAST_CLEANUP,
      JSON.stringify({ lastCleanupDate: now.toISOString() })
    );

    console.log(`[useDeliveries] Cleanup: Removed ${history.entries.length - filtered.length} old entries`);
  } catch (error) {
    console.error('[useDeliveries] Error during cleanup:', error);
  }
}, []);

// Ejecutar cleanup al montar hook
useEffect(() => {
  cleanupHistory();
}, [cleanupHistory]);
```

---

## üîó DATA FLOW COMPLETO

### Diagrama End-to-End

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 1: Registro Env√≠o (Evening Cut - Wizard Paso N)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
  Usuario completa formulario:
  - Cliente: Carlos G√≥mez
  - Monto: $113.00
  - Courier: C807
  - Gu√≠a: APA-1832-202510230001
         ‚Üì
  DeliveryManager.handleSubmit()
  ‚Üí Crear DeliveryEntry con UUID
  ‚Üí Validar campos (validateForm)
  ‚Üí Agregar a deliveries array
  ‚Üí Trigger onDeliveriesChange callback
         ‚Üì
  useDeliveries.addDelivery()
  ‚Üí setPending([...pending, newDelivery])
  ‚Üí saveToStorage(updated) // Debounced 500ms
         ‚Üì
  localStorage.setItem('cashguard_deliveries_pending', JSON.stringify(data))
         ‚úÖ Env√≠o registrado y persistido

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 2: C√°lculo Ajuste SICAR (Durante Corte Nocturno)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
  Sistema calcula totales:
  - SICAR esperado: $1,550.00
  - Electr√≥nicos: $100.00
  - Deliveries pendientes: $113.00
         ‚Üì
  adjustSICAR(1550, 100, [delivery])
  ‚Üí 1550 - 100 - 113 = $1,337.00
         ‚Üì
  CashGuard compara:
  - Efectivo contado: $1,340.00
  - SICAR ajustado: $1,337.00
  - Diferencia: +$3.00 ‚úÖ (dentro threshold)
         ‚úÖ Corte cierra correctamente

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 3: Dashboard Acumulado (Cualquier momento)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
  Usuario abre DeliveryDashboard
         ‚Üì
  useDeliveries.loadFromStorage()
  ‚Üí Cargar localStorage.getItem('cashguard_deliveries_pending')
  ‚Üí Validar cada entry con isDeliveryEntry()
  ‚Üí setPending(validated)
         ‚Üì
  useDeliverySummary(pending)
  ‚Üí buildDeliverySummary(pending)
  ‚Üí Calcular totales, alertas, por courier
         ‚Üì
  Renderizar dashboard:
  - Total pendiente: $1,245.00 (12 env√≠os)
  - C807: $800 (8 env√≠os)
  - Melos: $445 (4 env√≠os)
  - Alertas: 2 warning, 1 urgent, 0 critical
         ‚úÖ Usuario ve estado completo en tiempo real

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 4: Marcar Como Cobrado (Dashboard)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
  Usuario click "Marcar Cobrado" en delivery
         ‚Üì
  useDeliveries.markAsPaid(deliveryId)
  ‚Üí Encontrar delivery en pending
  ‚Üí Actualizar: status = 'paid', paidAt = now
  ‚Üí Remover de pending array
  ‚Üí Agregar a history array
         ‚Üì
  saveToStorage(updatedPending) // Actualizar pending
  saveToHistory(updatedHistory) // Actualizar hist√≥rico
         ‚Üì
  localStorage:
  - 'cashguard_deliveries_pending': Sin delivery (eliminado)
  - 'cashguard_deliveries_history': Con delivery (agregado)
         ‚úÖ Delivery movido a hist√≥rico

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 5: Reporte WhatsApp (Corte Nocturno)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
  generateCompleteReport()
  ‚Üí Cargar pending deliveries
  ‚Üí Construir summary con buildDeliverySummary()
  ‚Üí Formatear secci√≥n ENV√çOS PENDIENTES:

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì¶ *ENV√çOS PENDIENTES COD*

üíº *Total:* $1,245.00 (12 env√≠os)

üöö *Por Courier:*
‚òê C807: $800.00 (8 env√≠os)
‚òê Melos: $445.00 (4 env√≠os)

‚ö†Ô∏è *Alertas:*
üü° 7+ d√≠as: 2 env√≠os
üî¥ 15+ d√≠as: 1 env√≠o
üö® 30+ d√≠as: 0 env√≠os

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

  ‚Üí Agregar al reporte completo
  ‚Üí Enviar por WhatsApp
         ‚úÖ Supervisor ve estado delivery en reporte
```

### State Management Patterns

**Patr√≥n Observer con Callbacks:**
```typescript
// Componente padre (CashCounter)
const [todayDeliveries, setTodayDeliveries] = useState<DeliveryEntry[]>([]);

const handleDeliveriesChange = useCallback((deliveries: DeliveryEntry[]) => {
  setTodayDeliveries(deliveries);
  // Actualizar c√°lculo SICAR ajustado inmediatamente
  recalculateSICAR(deliveries);
}, [recalculateSICAR]);

return (
  <DeliveryManager
    initialDeliveries={todayDeliveries}
    onDeliveriesChange={handleDeliveriesChange}
  />
);
```

**Patr√≥n Derived State con useMemo:**
```typescript
// useDeliverySummary.ts
export function useDeliverySummary(pending: DeliveryEntry[]): DeliverySummary {
  return useMemo(() => {
    return buildDeliverySummary(pending);
  }, [pending]); // Recalcula solo cuando pending cambia
}
```

---

## üö® SISTEMA DE ALERTAS

### L√≥gica Detecci√≥n Alertas

**Niveles de Alerta:**
```typescript
// utils/deliveryCalculation.ts

/**
 * Determina nivel alerta seg√∫n d√≠as pendiente
 *
 * Umbrales:
 * - 0-6 d√≠as: ok (verde, sin alerta)
 * - 7-14 d√≠as: warning (amarillo, requiere seguimiento)
 * - 15-29 d√≠as: urgent (naranja, requiere acci√≥n inmediata)
 * - 30+ d√≠as: critical (rojo, requiere escalaci√≥n gerencia)
 */
export function getAlertLevel(days: number): AlertLevel {
  if (days >= 30) return 'critical';
  if (days >= 15) return 'urgent';
  if (days >= 7) return 'warning';
  return 'ok';
}

/**
 * Obtiene descripci√≥n legible del nivel alerta
 */
export function getAlertDescription(level: AlertLevel): string {
  switch (level) {
    case 'critical':
      return 'Cr√≠tico - Requiere acci√≥n gerencia inmediata';
    case 'urgent':
      return 'Urgente - Requiere contactar courier hoy';
    case 'warning':
      return 'Advertencia - Hacer seguimiento esta semana';
    case 'ok':
      return 'Normal - Sin acci√≥n requerida';
  }
}
```

### Badge Rendering Logic

**Componente DeliveryAlertBadge:**
```typescript
// components/deliveries/DeliveryAlertBadge.tsx

import React from 'react';
import { getDaysPending, getAlertLevel } from '@/utils/deliveryCalculation';
import type { DeliveryEntry } from '@/types/deliveries';

interface DeliveryAlertBadgeProps {
  delivery: DeliveryEntry;
  showLabel?: boolean;
}

export const DeliveryAlertBadge: React.FC<DeliveryAlertBadgeProps> = ({
  delivery,
  showLabel = false
}) => {
  const days = getDaysPending(delivery.createdAt);
  const level = getAlertLevel(days);

  const colors = {
    ok: 'bg-green-100 text-green-800',
    warning: 'bg-yellow-100 text-yellow-800',
    urgent: 'bg-orange-100 text-orange-800',
    critical: 'bg-red-100 text-red-800'
  };

  const icons = {
    ok: '‚úì',
    warning: '‚ö†Ô∏è',
    urgent: 'üî¥',
    critical: 'üö®'
  };

  return (
    <span
      className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold ${colors[level]}`}
    >
      <span>{icons[level]}</span>
      <span>{days} d√≠as</span>
      {showLabel && <span className="ml-1">({level})</span>}
    </span>
  );
};
```

### Modal Blocking Logic (Critical Alerts)

**Modal educativo para alertas cr√≠ticas:**
```typescript
// components/deliveries/DeliveryEducationModal.tsx

/**
 * Modal educativo que bloquea continuar si hay deliveries cr√≠ticos
 *
 * Aparece cuando:
 * - Usuario intenta cerrar corte nocturno
 * - Existen deliveries con 30+ d√≠as pendientes
 * - Supervisor debe reconocer situaci√≥n antes de continuar
 */

interface DeliveryEducationModalProps {
  criticalDeliveries: DeliveryEntry[];
  onAcknowledge: () => void;
  onCancel: () => void;
}

export const DeliveryEducationModal: React.FC<DeliveryEducationModalProps> = ({
  criticalDeliveries,
  onAcknowledge,
  onCancel
}) => {
  const totalCritical = criticalDeliveries.reduce((sum, d) => sum + d.amount, 0);

  return (
    <AlertDialog open>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>
            üö® Atenci√≥n: {criticalDeliveries.length} Env√≠os Cr√≠ticos
          </AlertDialogTitle>
          <AlertDialogDescription>
            <p className="mb-4">
              Hay <strong>{criticalDeliveries.length} env√≠os</strong> con <strong>30+ d√≠as pendientes</strong> por un total de <strong>${totalCritical.toFixed(2)}</strong>.
            </p>

            <div className="space-y-2 mb-4">
              {criticalDeliveries.map(d => (
                <div key={d.id} className="p-2 border rounded bg-red-50">
                  <p className="font-semibold">{d.customerName}</p>
                  <p className="text-sm">
                    {getDaysPending(d.createdAt)} d√≠as ‚Ä¢ {d.courier} ‚Ä¢ ${d.amount.toFixed(2)}
                  </p>
                </div>
              ))}
            </div>

            <p className="text-sm text-muted-foreground">
              <strong>Acciones requeridas:</strong>
            </p>
            <ul className="list-disc list-inside text-sm text-muted-foreground mt-2">
              <li>Contactar courier inmediatamente</li>
              <li>Verificar estado env√≠os con cliente</li>
              <li>Escalar a gerencia si no hay resoluci√≥n en 3 d√≠as</li>
            </ul>
          </AlertDialogDescription>
        </AlertDialogHeader>

        <AlertDialogFooter>
          <AlertDialogCancel onClick={onCancel}>
            Cancelar Cierre
          </AlertDialogCancel>
          <AlertDialogAction onClick={onAcknowledge}>
            Entiendo, Continuar
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
};
```

---

## üì± REPORTE WHATSAPP

### Formatting Templates

**Secci√≥n Env√≠os Pendientes (agregada a reporte nocturno):**
```typescript
// utils/deliveryFormatters.ts

/**
 * Genera secci√≥n env√≠os pendientes para reporte WhatsApp
 */
export function generateDeliverySectionWhatsApp(
  pending: DeliveryEntry[],
  summary: DeliverySummary
): string {
  if (pending.length === 0) {
    return `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì¶ *ENV√çOS PENDIENTES COD*

‚úÖ Sin env√≠os pendientes

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
  }

  let section = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì¶ *ENV√çOS PENDIENTES COD*

üíº *Total:* $${summary.totalPending.toFixed(2)} (${summary.countPending} env√≠os)

üöö *Por Courier:*
‚òê C807: $${summary.byCourier.C807.total.toFixed(2)} (${summary.byCourier.C807.count} env√≠os)
‚òê Melos: $${summary.byCourier.Melos.total.toFixed(2)} (${summary.byCourier.Melos.count} env√≠os)
‚òê Otro: $${summary.byCourier.Otro.total.toFixed(2)} (${summary.byCourier.Otro.count} env√≠os)
`;

  // Agregar alertas si existen
  const hasAlerts =
    summary.alerts.warning7Days > 0 ||
    summary.alerts.urgent15Days > 0 ||
    summary.alerts.critical30Days > 0;

  if (hasAlerts) {
    section += `
‚ö†Ô∏è *Alertas:*
`;
    if (summary.alerts.warning7Days > 0) {
      section += `üü° 7+ d√≠as: ${summary.alerts.warning7Days} env√≠os\n`;
    }
    if (summary.alerts.urgent15Days > 0) {
      section += `üî¥ 15+ d√≠as: ${summary.alerts.urgent15Days} env√≠os\n`;
    }
    if (summary.alerts.critical30Days > 0) {
      section += `üö® 30+ d√≠as: ${summary.alerts.critical30Days} env√≠os\n`;
    }
  }

  section += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;

  return section;
}

/**
 * Genera detalle env√≠os cr√≠ticos para reporte
 */
export function generateCriticalDeliveriesDetail(
  deliveries: DeliveryEntry[]
): string {
  const critical = deliveries.filter(
    d => getAlertLevel(getDaysPending(d.createdAt)) === 'critical'
  );

  if (critical.length === 0) return '';

  let detail = `
üö® *ENV√çOS CR√çTICOS (30+ D√çAS):*

`;

  critical.forEach((d, index) => {
    const days = getDaysPending(d.createdAt);
    detail += `${index + 1}. ${d.customerName}
   ${d.courier} ‚Ä¢ $${d.amount.toFixed(2)} ‚Ä¢ ${days} d√≠as
   Gu√≠a: ${d.guideNumber || 'N/A'} ‚Ä¢ Fact: ${d.invoiceNumber || 'N/A'}

`;
  });

  return detail;
}
```

### Generation Logic

**Integraci√≥n en generateCompleteReport():**
```typescript
// CashCalculation.tsx (fragmento)

const generateCompleteReport = useCallback(() => {
  const deliveries = useDeliveries(); // Hook que carga de localStorage
  const summary = buildDeliverySummary(deliveries.pending);

  // ... otras secciones reporte ...

  // Agregar secci√≥n env√≠os pendientes
  const deliverySection = generateDeliverySectionWhatsApp(
    deliveries.pending,
    summary
  );

  // Agregar detalle cr√≠ticos si existen
  const criticalDetail = generateCriticalDeliveriesDetail(deliveries.pending);

  return `
${headerSeverity}

üìä *CORTE DE CAJA* - ${calculationData?.timestamp}
Sucursal: ${selectedBranch?.name}
Cajero: ${selectedCashier?.name}
Testigo: ${selectedWitness?.name}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä *RESUMEN EJECUTIVO*

üí∞ Efectivo Contado: *${formatCurrency(calculationData?.totalCash)}*
üí≥ Pagos Electr√≥nicos: *${formatCurrency(totalElectronic)}*
üì¶ *Entregado a Gerencia: ${formatCurrency(deliveryCalculation?.amountToDeliver)}*
üè¢ Qued√≥ en Caja: ${formatCurrency(50)}

üíº Total D√≠a: *${formatCurrency(calculationData?.totalGeneral)}*
üéØ SICAR Esperado: ${formatCurrency(adjustedSICAR)}
${emoji} Diferencia: *${formatCurrency(diff)} (${label})*

${deliverySection}

${criticalDetail}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

... resto del reporte ...
`;
}, [calculationData, deliveries, selectedBranch, selectedCashier, selectedWitness]);
```

### Mock Examples

**Ejemplo 1: Sin Env√≠os**
```
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì¶ *ENV√çOS PENDIENTES COD*

‚úÖ Sin env√≠os pendientes

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

**Ejemplo 2: Con Env√≠os Normales**
```
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì¶ *ENV√çOS PENDIENTES COD*

üíº *Total:* $1,245.00 (12 env√≠os)

üöö *Por Courier:*
‚òê C807: $800.00 (8 env√≠os)
‚òê Melos: $445.00 (4 env√≠os)
‚òê Otro: $0.00 (0 env√≠os)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

**Ejemplo 3: Con Alertas + Detalle Cr√≠ticos**
```
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì¶ *ENV√çOS PENDIENTES COD*

üíº *Total:* $1,245.00 (12 env√≠os)

üöö *Por Courier:*
‚òê C807: $800.00 (8 env√≠os)
‚òê Melos: $445.00 (4 env√≠os)

‚ö†Ô∏è *Alertas:*
üü° 7+ d√≠as: 2 env√≠os
üî¥ 15+ d√≠as: 1 env√≠o
üö® 30+ d√≠as: 2 env√≠os

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üö® *ENV√çOS CR√çTICOS (30+ D√çAS):*

1. Carlos G√≥mez
   C807 ‚Ä¢ $113.00 ‚Ä¢ 35 d√≠as
   Gu√≠a: APA-1832-202509180001 ‚Ä¢ Fact: 12347

2. Mar√≠a L√≥pez
   Melos ‚Ä¢ $84.75 ‚Ä¢ 32 d√≠as
   Gu√≠a: MEL-9876 ‚Ä¢ Fact: 12348

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
```

---

## üß™ TESTING STRATEGY

### Test Plan Overview

**Coverage Requirements:**
- ‚úÖ Lines: >90% (objetivo: 95%+)
- ‚úÖ Branches: >85% (objetivo: 90%+)
- ‚úÖ Functions: >90%
- ‚úÖ TIER 0 mandatory: Helpers c√°lculo financiero

### Unit Tests

**1. deliveryCalculation.test.ts (TIER 0 - 30+ tests)**
```typescript
describe('deliveryCalculation.ts - TIER 0', () => {
  describe('getDaysPending()', () => {
    it('debe calcular d√≠as correctamente', () => {
      const created = new Date('2025-10-15T14:00:00Z');
      const now = new Date('2025-10-23T14:00:00Z');

      // Mock Date.now para test determin√≠stico
      jest.spyOn(global, 'Date').mockImplementation(() => now as any);

      expect(getDaysPending(created.toISOString())).toBe(8);
    });

    it('debe retornar 0 para fechas futuras', () => {
      const future = new Date(Date.now() + 86400000).toISOString();
      expect(getDaysPending(future)).toBe(0);
    });

    it('debe manejar timestamps ISO 8601 con timezone', () => {
      expect(getDaysPending('2025-10-15T14:00:00-06:00')).toBeGreaterThanOrEqual(0);
    });
  });

  describe('getAlertLevel()', () => {
    it('debe retornar "ok" para 0-6 d√≠as', () => {
      expect(getAlertLevel(0)).toBe('ok');
      expect(getAlertLevel(6)).toBe('ok');
    });

    it('debe retornar "warning" para 7-14 d√≠as', () => {
      expect(getAlertLevel(7)).toBe('warning');
      expect(getAlertLevel(14)).toBe('warning');
    });

    it('debe retornar "urgent" para 15-29 d√≠as', () => {
      expect(getAlertLevel(15)).toBe('urgent');
      expect(getAlertLevel(29)).toBe('urgent');
    });

    it('debe retornar "critical" para 30+ d√≠as', () => {
      expect(getAlertLevel(30)).toBe('critical');
      expect(getAlertLevel(100)).toBe('critical');
    });
  });

  describe('buildDeliverySummary()', () => {
    it('debe construir resumen vac√≠o correctamente', () => {
      const summary = buildDeliverySummary([]);
      expect(summary.totalPending).toBe(0);
      expect(summary.countPending).toBe(0);
      expect(summary.byCourier.C807.total).toBe(0);
    });

    it('debe sumar totales correctamente', () => {
      const deliveries: DeliveryEntry[] = [
        {
          id: 'uuid-1',
          customerName: 'Cliente 1',
          amount: 100,
          courier: 'C807',
          status: 'pending_cod',
          createdAt: new Date('2025-10-15').toISOString()
        },
        {
          id: 'uuid-2',
          customerName: 'Cliente 2',
          amount: 200,
          courier: 'C807',
          status: 'pending_cod',
          createdAt: new Date('2025-10-15').toISOString()
        }
      ];

      const summary = buildDeliverySummary(deliveries);
      expect(summary.totalPending).toBe(300);
      expect(summary.byCourier.C807.total).toBe(300);
      expect(summary.byCourier.C807.count).toBe(2);
    });

    it('debe contar alertas correctamente', () => {
      // Mock Date.now
      const now = new Date('2025-10-23T14:00:00Z');
      jest.spyOn(global, 'Date').mockImplementation(() => now as any);

      const deliveries: DeliveryEntry[] = [
        {
          id: 'uuid-1',
          customerName: 'Cliente 1',
          amount: 100,
          courier: 'C807',
          status: 'pending_cod',
          createdAt: new Date('2025-10-15').toISOString() // 8 d√≠as ‚Üí warning
        },
        {
          id: 'uuid-2',
          customerName: 'Cliente 2',
          amount: 200,
          courier: 'Melos',
          status: 'pending_cod',
          createdAt: new Date('2025-10-05').toISOString() // 18 d√≠as ‚Üí urgent
        },
        {
          id: 'uuid-3',
          customerName: 'Cliente 3',
          amount: 300,
          courier: 'C807',
          status: 'pending_cod',
          createdAt: new Date('2025-09-15').toISOString() // 38 d√≠as ‚Üí critical
        }
      ];

      const summary = buildDeliverySummary(deliveries);
      expect(summary.alerts.warning7Days).toBe(1);
      expect(summary.alerts.urgent15Days).toBe(1);
      expect(summary.alerts.critical30Days).toBe(1);
    });
  });

  describe('adjustSICAR()', () => {
    it('debe ajustar SICAR correctamente', () => {
      const deliveries: DeliveryEntry[] = [
        { id: 'uuid-1', amount: 113, /* ... */ },
        { id: 'uuid-2', amount: 84.75, /* ... */ }
      ];

      const adjusted = adjustSICAR(1550, 100, deliveries);
      expect(adjusted).toBe(1550 - 100 - 113 - 84.75); // 1252.25
    });

    it('debe manejar deliveries vac√≠o', () => {
      const adjusted = adjustSICAR(1550, 100, []);
      expect(adjusted).toBe(1450);
    });
  });
});
```

**2. useDeliveries.test.ts (15-20 tests)**
```typescript
describe('useDeliveries Hook', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  it('debe inicializar con deliveries vac√≠o', () => {
    const { result } = renderHook(() => useDeliveries());
    expect(result.current.pending).toEqual([]);
  });

  it('debe agregar delivery correctamente', () => {
    const { result } = renderHook(() => useDeliveries());

    act(() => {
      result.current.addDelivery({
        id: 'uuid-1',
        customerName: 'Carlos',
        amount: 100,
        courier: 'C807',
        status: 'pending_cod',
        createdAt: new Date().toISOString()
      });
    });

    expect(result.current.pending.length).toBe(1);
    expect(result.current.pending[0].customerName).toBe('Carlos');
  });

  it('debe persistir en localStorage', async () => {
    const { result } = renderHook(() => useDeliveries());

    act(() => {
      result.current.addDelivery({
        id: 'uuid-1',
        customerName: 'Carlos',
        amount: 100,
        courier: 'C807',
        status: 'pending_cod',
        createdAt: new Date().toISOString()
      });
    });

    // Esperar debounce 500ms
    await waitFor(() => {
      const stored = localStorage.getItem(STORAGE_KEYS.PENDING);
      expect(stored).toBeTruthy();
      const parsed = JSON.parse(stored!);
      expect(parsed.deliveries).toHaveLength(1);
    });
  });

  it('debe marcar como cobrado correctamente', () => {
    // ... similar test
  });
});
```

### Integration Tests

**3. DeliveryManager.test.tsx (20-25 tests)**
```typescript
describe('DeliveryManager Component', () => {
  it('debe renderizar formulario al click "Registrar Env√≠o"', () => {
    render(<DeliveryManager />);

    const button = screen.getByText(/Registrar Env√≠o/i);
    fireEvent.click(button);

    expect(screen.getByLabelText(/Cliente/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/Monto USD/i)).toBeInTheDocument();
  });

  it('debe validar campos requeridos', async () => {
    render(<DeliveryManager />);

    fireEvent.click(screen.getByText(/Registrar Env√≠o/i));

    const submitButton = screen.getByText(/Registrar/i);
    fireEvent.click(submitButton);

    await waitFor(() => {
      expect(screen.getByText(/M√≠nimo 3 caracteres/i)).toBeInTheDocument();
    });
  });

  it('debe agregar delivery a la lista', async () => {
    const onDeliveriesChange = jest.fn();
    render(<DeliveryManager onDeliveriesChange={onDeliveriesChange} />);

    fireEvent.click(screen.getByText(/Registrar Env√≠o/i));

    fireEvent.change(screen.getByLabelText(/Cliente/i), {
      target: { value: 'Carlos G√≥mez' }
    });
    fireEvent.change(screen.getByLabelText(/Monto USD/i), {
      target: { value: '113.00' }
    });

    fireEvent.click(screen.getByText(/Registrar/i));

    await waitFor(() => {
      expect(onDeliveriesChange).toHaveBeenCalledWith(
        expect.arrayContaining([
          expect.objectContaining({
            customerName: 'Carlos G√≥mez',
            amount: 113
          })
        ])
      );
    });
  });
});
```

**4. deliveryIntegration.test.tsx (E2E Flows)**
```typescript
describe('Delivery System Integration', () => {
  it('debe completar flujo completo: registro ‚Üí dashboard ‚Üí marcar cobrado', async () => {
    // 1. Registrar delivery
    render(<DeliveryManager />);

    fireEvent.click(screen.getByText(/Registrar Env√≠o/i));
    fireEvent.change(screen.getByLabelText(/Cliente/i), {
      target: { value: 'Carlos' }
    });
    fireEvent.change(screen.getByLabelText(/Monto USD/i), {
      target: { value: '113' }
    });
    fireEvent.click(screen.getByText(/Registrar/i));

    // 2. Verificar en lista
    await waitFor(() => {
      expect(screen.getByText('Carlos')).toBeInTheDocument();
    });

    // 3. Abrir dashboard
    render(<DeliveryDashboard />);

    await waitFor(() => {
      expect(screen.getByText('Carlos')).toBeInTheDocument();
      expect(screen.getByText('$113.00')).toBeInTheDocument();
    });

    // 4. Marcar como cobrado
    fireEvent.click(screen.getByText(/Ver/i));
    fireEvent.click(screen.getByText(/Marcar Cobrado/i));

    // 5. Verificar ya no est√° en pendientes
    await waitFor(() => {
      expect(screen.queryByText('Carlos')).not.toBeInTheDocument();
    });
  });
});
```

---

## ‚ö° PERFORMANCE CONSIDERATIONS

### localStorage Limits

**Tama√±o M√°ximo:**
- localStorage: ~5MB por domain (mayor√≠a browsers)
- Estimado: 1 delivery = ~500 bytes JSON
- Capacidad: ~10,000 deliveries (suficiente para 5+ a√±os Paradise)

**Monitoreo L√≠mites:**
```typescript
// hooks/useDeliveries.ts (fragmento)

const checkStorageSize = useCallback(() => {
  try {
    let totalSize = 0;
    for (let key in localStorage) {
      if (key.startsWith('cashguard_deliveries_')) {
        totalSize += localStorage[key].length * 2; // UTF-16 = 2 bytes/char
      }
    }

    const MB = totalSize / (1024 * 1024);

    if (MB > 4) {
      console.warn(`[useDeliveries] Storage size: ${MB.toFixed(2)}MB (close to 5MB limit)`);
      // Trigger cleanup autom√°tico
      cleanupHistory();
    }

    return MB;
  } catch (error) {
    console.error('[useDeliveries] Error checking storage size:', error);
    return 0;
  }
}, [cleanupHistory]);
```

### Memoization Strategies

**useMemo para c√°lculos pesados:**
```typescript
// DeliveryDashboard.tsx (fragmento)

const filteredDeliveries = useMemo(() => {
  let filtered = [...pending];

  // Filtros (courier, search, date range)
  // ... l√≥gica filtrado ...

  // Ordenamiento
  filtered.sort((a, b) => {
    // ... l√≥gica sort ...
  });

  return filtered;
}, [pending, filters, sortBy, sortOrder]); // Solo recalcula si cambian estas deps
```

**useCallback para event handlers:**
```typescript
const handleExportCSV = useCallback(() => {
  // ... l√≥gica export ...
}, [filteredDeliveries]); // Memoriza funci√≥n, solo cambia si filteredDeliveries cambia
```

### Large Dataset Handling (1000+ Deliveries)

**Virtual Scrolling (Opcional - Si >500 deliveries):**
```typescript
// Usar react-window para virtualizar tabla

import { FixedSizeList } from 'react-window';

const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => (
  <div style={style}>
    <DeliveryRow delivery={filteredDeliveries[index]} />
  </div>
);

<FixedSizeList
  height={600}
  itemCount={filteredDeliveries.length}
  itemSize={60}
  width="100%"
>
  {Row}
</FixedSizeList>
```

**Paginaci√≥n (Alternativa):**
```typescript
const PAGE_SIZE = 50;
const [page, setPage] = useState(0);

const paginatedDeliveries = useMemo(() => {
  const start = page * PAGE_SIZE;
  return filteredDeliveries.slice(start, start + PAGE_SIZE);
}, [filteredDeliveries, page]);
```

### Mobile Performance Optimization

**Lazy Loading Componentes:**
```typescript
// App.tsx

const DeliveryDashboard = React.lazy(() => import('@/components/deliveries/DeliveryDashboard'));

// Renderizar con Suspense
<Suspense fallback={<Spinner />}>
  <DeliveryDashboard />
</Suspense>
```

**Debouncing Search Input:**
```typescript
const [searchQuery, setSearchQuery] = useState('');
const debouncedSearch = useMemo(
  () => debounce((query: string) => {
    setFilters(f => ({ ...f, searchQuery: query }));
  }, 300),
  []
);

<Input
  onChange={e => debouncedSearch(e.target.value)}
  placeholder="Buscar..."
/>
```

---

## üìä RESUMEN ARQUITECT√ìNICO

### Checklist Implementaci√≥n

**TypeScript:**
- ‚úÖ Interfaces completas con JSDoc
- ‚úÖ Type guards con runtime validation
- ‚úÖ Zero `any` types
- ‚úÖ Strict mode habilitado

**React Components:**
- ‚úÖ DeliveryManager (formulario + lista d√≠a)
- ‚úÖ DeliveryDashboard (dashboard acumulado)
- ‚úÖ DeliveryDetailsModal (modal detalles)
- ‚úÖ DeliveryAlertBadge (badge d√≠as/alertas)
- ‚úÖ DeliveryEducationModal (modal educativo cr√≠ticos)

**Custom Hooks:**
- ‚úÖ useDeliveries (CRUD operations)
- ‚úÖ useDeliveryAlerts (detecci√≥n alertas)
- ‚úÖ useDeliverySummary (c√°lculo resumen)

**Helpers:**
- ‚úÖ deliveryCalculation.ts (getDaysPending, getAlertLevel, buildSummary, adjustSICAR)
- ‚úÖ deliveryValidation.ts (isDeliveryEntry, type guards)
- ‚úÖ deliveryFormatters.ts (generateWhatsAppSection, formatDate)

**localStorage:**
- ‚úÖ Strategy definida (pending + history + cleanup)
- ‚úÖ Persistence patterns (save on change debounced)
- ‚úÖ Data migration versioned
- ‚úÖ Cleanup autom√°tico hist√≥rico

**Testing:**
- ‚úÖ TIER 0 mandatory (deliveryCalculation.test.ts)
- ‚úÖ Unit tests (30+ tests c√°lculos)
- ‚úÖ Integration tests (60+ tests componentes)
- ‚úÖ E2E flows (10+ tests)
- ‚úÖ Coverage >90%

**Performance:**
- ‚úÖ useMemo para filtros pesados
- ‚úÖ useCallback para event handlers
- ‚úÖ Debouncing search + save
- ‚úÖ Virtual scrolling ready (si >500 deliveries)
- ‚úÖ Lazy loading componentes

---

**üôè Gloria a Dios por guiarnos en esta arquitectura t√©cnica profesional.**

**Acuarios Paradise - Herramientas profesionales de tope de gama con valores cristianos**

